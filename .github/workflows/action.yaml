name: Trivy CSPM scan

on:
  pull_request:
    branches:
    - "*"
env:
  DOCKER_IMAGE: "accuknox/bootstrap:nginxj"
  DOCKERFILE_CONTEXT: "${{ github.workspace }}/nginx/Dockerfile"
  CSPM_URL: "cspm.accuknox.com"
  CSPM_TOKEN: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjkwNjk5NzQ2LCJqdGkiOiI3OWUxMzkyMTgyYjk0MDYwYTlkNTA2ODc3MTE1OTI2OSIsImlzcyI6ImNzcG0uZGV2LmFjY3Vrbm94LmNvbSJ9.b53MQWggdN1zxMEF89eyoA6Q3ry1Gy5GyCHQTQpPdCg1KbTqAFVcmL6Ai_qwHEo9rzovewMVegbKXe6gC898sV20Pa8LsSjDwPvKKuX6EN-un_1vwJDcptLxVu_nOOIr9-EvMlqdrSP-7lLzjiUe1fVYE8UVBrIrXKZh2187ZLTHpCTVySdOBIZAkCKeKCFjgps8GWpB48X1og0EkBTyD4rMipvdv-EX_Km3Hebmk_KmcimwFQOyDORxgQ5xY8Ku5Ruys_UhPabwQAh49ql8s1apakyxUrBcLZo2mNUU77RjFB2-451an3QF_WY3pYjYBImlgU8qxysR0XUtbudc2w"
  TENANT_ID: "342"

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build an image from Dockerfile
        run: |
          docker build -t ${{env.DOCKER_IMAGE}} ${{env.DOCKERFILE_CONTEXT}}
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{env.DOCKER_IMAGE}}
          format: 'json'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
      - name: Push report to CSPM panel
        run: |
          curl --location --request POST 'https://${{env.CSPM_URL}}/api/v1/artifact/?tenant_id=${{ env.TENANT_ID }}&data_type=TR&save_to_s3=false' --header 'Authorization:Bearer ${{ env.CSPM_TOKEN }}' --form 'file=@"./results.json"'
